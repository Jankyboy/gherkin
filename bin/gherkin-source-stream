#!/usr/bin/env bash
#
# Generates Cucumber source events according to the Cucumber Event Protocol,
# https://docs.cucumber.io/event-protocol/
#
# This script is primarily a debugging/testing tool to make it easy to generate
# events from source files without having to use a full-blown Cucumber implementation.
#
# For example, the output from this script can be piped further to the gherkin CLI,
# which will add pickle events to the output (and possibly ASTs if that's specified)
#

path=${1:-.}
uuid=$(uuidgen)

find ${path} -name "*.feature" |
while read path
do
    jq --compact-output --monochrome-output --raw-output --null-input \
    --argjson timestamp $(date +%s) \
    --arg series ${uuid} \
    --arg uri ${path} \
    --arg data "$(cat ${path})" \
    '{
        "type": "source",
        "timestamp": $timestamp,
        "series": $series,
        "uri": $uri,
        "data": $data,
        "media": {
            "encoding": "utf-8",
            "type": "text/vnd.cucumber.gherkin+plain"
        }
    }'
done
